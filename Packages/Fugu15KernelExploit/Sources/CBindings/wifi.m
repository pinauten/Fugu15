#import <Foundation/Foundation.h>
#import <dlfcn.h>

void *wifiManager = NULL;
void *(*WiFiManagerClientCreate)(CFAllocatorRef allocator, int flags);
CFPropertyListRef (*WiFiManagerClientCopyProperty)(void *manager, CFStringRef property);
void (*WiFiManagerClientSetProperty)(void *manager, CFStringRef property, CFPropertyListRef value);

void loadWifiManager(void)
{
	static dispatch_once_t onceToken;
	dispatch_once (&onceToken, ^{
		void *wifiHandle = dlopen("/System/Library/PrivateFrameworks/MobileWiFi.framework/MobileWiFi", RTLD_NOW);
		WiFiManagerClientCreate =  dlsym(wifiHandle, "WiFiManagerClientCreate");
		WiFiManagerClientCopyProperty = dlsym(wifiHandle, "WiFiManagerClientCopyProperty");
		WiFiManagerClientSetProperty = dlsym(wifiHandle, "WiFiManagerClientSetProperty");
		wifiManager = WiFiManagerClientCreate(kCFAllocatorDefault, 0);
	});
}

bool wifiIsEnabled(void)
{
	loadWifiManager();

	CFBooleanRef isEnabled = WiFiManagerClientCopyProperty(wifiManager, CFSTR("AllowEnable"));
	bool isEnabledBool = false;
	if (isEnabled) {
		isEnabledBool = CFBooleanGetValue(isEnabled);
		CFRelease(isEnabled);
	}
	return isEnabledBool;
}

void setWifiEnabled(bool enabled)
{
	loadWifiManager();

	WiFiManagerClientSetProperty(wifiManager, CFSTR("AllowEnable"), enabled ? kCFBooleanTrue : kCFBooleanFalse);
}